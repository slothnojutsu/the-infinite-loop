<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">      <!--mobile-friendly-->
    <title>PLocation - ParKing</title>     <!--shown on brower tab-->
    <link rel="stylesheet" href="styles.css">           <!--to link to css file for styling-->
    <link href="https://fonts.googleapis.com/css2?family=Lora&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">

</head>
<body>
    <header>
        <h1>Welcome to ParKing
            <img src="crown2.png" alt="Logo" class="header-image">
        </h1>

        <p>Your ultimate solution for finding parking spots nearby!</p></h1>
        <h2>Find Availability</h2>

        <div class="content-wrapper">
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="zip.html">Availability</a></li>
                    <li><a href="profile.html">Profile</a></li>
                    <li><a href="login.html">Sign Up</a></li>
                </ul>
            </nav>
        </div>
        
        <p></p> <!--empty line, so they are not too close to one another-->
        
    </header>
    <div id="container">
        <p>Enter your ZIP code to check parking availability or use your current location:</p>
        <input type="text" id="zipCode" placeholder="Enter ZIP code">
        
        <!-- Container to separate the buttons -->
        <div class="button-container">
            <button onclick="findParking()">Search</button>
            <button onclick="useCurrentLocation()">Use My Location</button>
        </div>
        
        <div id="results"></div>

        <script>
        const savedZips = ["76904", "76901", "76903"]; // Add more nearby parking locations

        async function getCoordinates(zip) {
            const response = await fetch(`https://api.zippopotam.us/us/${zip}`);
            if (!response.ok) throw new Error("Invalid ZIP code");
            const data = await response.json();
            return {
                lat: parseFloat(data.places[0].latitude),
                lon: parseFloat(data.places[0].longitude)
            };
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const toRad = angle => angle * Math.PI / 180;
            const R = 3958.8; // miles
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2)**2 +
                    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                    Math.sin(dLon/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function findParking() {
            const zip = document.getElementById('zipCode').value;
            const resultDiv = document.getElementById('results');

            if (!zip) {
                resultDiv.innerHTML = "Please enter a ZIP code.";
                return;
            }

            resultDiv.innerHTML = "Searching nearby parking spots...";

            try {
                const inputCoords = await getCoordinates(zip);

                const distances = await Promise.all(savedZips.map(async savedZip => {
                    const savedCoords = await getCoordinates(savedZip);
                    const distance = haversine(
                        inputCoords.lat, inputCoords.lon,
                        savedCoords.lat, savedCoords.lon
                    );
                    return { zip: savedZip, distance };
                }));

                distances.sort((a, b) => a.distance - b.distance);
                const nearby = distances.filter(d => d.distance <= 50); // You can change the radius here

                if (nearby.length === 0) {
                    resultDiv.innerHTML = "Sorry, no parking locations within 50 miles.";
                } else {
                    resultDiv.innerHTML = "<b>Closest parking spots:</b><br>" +nearby.map(d => `ZIP ${d.zip} — ${d.distance.toFixed(1)} miles away 
                            <button onclick="selectParking('${d.zip}')">Select</button>`).join("<br>");
                }
            } catch (err) {
                resultDiv.innerHTML = "Error: " + err.message;
            }
        }

    function useCurrentLocation() {
            const resultDiv = document.getElementById("results");

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async position => {
                    const { latitude: lat, longitude: lon } = position.coords;
                    resultDiv.innerHTML = "Searching nearby parking spots from your location...";

                    try {
                        const distances = await Promise.all(savedZips.map(async savedZip => {
                            const savedCoords = await getCoordinates(savedZip);
                            const distance = haversine(lat, lon, savedCoords.lat, savedCoords.lon);
                            return { zip: savedZip, distance };
                        }));

                        distances.sort((a, b) => a.distance - b.distance);
                        const nearby = distances.filter(d => d.distance <= 50);

                        if (nearby.length === 0) {
                            resultDiv.innerHTML = "Sorry, no parking locations within 50 miles.";
                        } else {
                            resultDiv.innerHTML = "<b>Closest parking spots:</b><br>" +nearby.map(d => `ZIP ${d.zip} — ${d.distance.toFixed(1)} miles away 
                            <button onclick="selectParking('${d.zip}')">Select</button>`).join("<br>");
                        }
                    } catch (err) {
                        resultDiv.innerHTML = "Error getting parking info: " + err.message;
                    }

                }, () => {
                    resultDiv.innerHTML = "Location access denied. Please enter ZIP manually.";
                });
            } else {
                resultDiv.innerHTML = "Geolocation not supported by your browser.";
            }
        }

        function selectParking(zip) {
            localStorage.setItem('parking-area', zip);
            window.location.href = 'time.html'; // redirect to select time page
}
        </script>

        
    </div>

    <footer>
        <h4>Why Choose ParKing?</h4>
        <p>ParKing helps you quickly locate parking spaces in your area. Whether you're at work, shopping, or at a concert, finding a spot has never been easier!</p>
        <p>Our system provides real-time updates on available spaces, ensuring you never waste time circling the block again.</p></p>
        
        <h5>&copy; 2025 ParKing. All rights reserved.</h5>
    </footer>

</body>
</html>
